
install.packages("ggplot2")
install.packages("ggpubr")
install.packages("agricolae")
install.packages("vegan")
#??×°??Òª?Ä°??????Ñ°?×°????Ê¡????Ò»??
library(ggplot2)
library(ggpubr)
library(agricolae)
library(vegan)
library(tidyverse)
#??????Òª?Ä·?????????????Ã»?Ð°?×°??Ð©??????Ê¹??

# otu=read.table('E:/lesson1/feature-table.taxonomy.txt',row.names = 1,skip=1,header=T,comment.char='',sep='\t')
data <- read.table("../Total.gut.sub3W1.filter_4_noChimera_rmAlignFail.otu_table.txt", row.names = 1, header = TRUE, skip = 1, comment.char = "", sep = "\t")

group <- read.table("../Total-color4.txt", sep = "\t", row.names = 1, header = TRUE)
group <- group[1]

otu <- data[which(colnames(data) %in% rownames(group))]

#'E:/lesson1/feature-table.taxonomy.txt'Îª?Ä¼?Â·????×¢??Ð±?ß·???
#row.names = 1Ö¸????Ò»??Îª????
#skip=1??????Ò»?Ð²???
#header=TÖ¸????Ò»????Ð§??Îª????
#sep='\t'??Ê¾Ö¸???Æ±???Îª?Ö¸???
#comment.char=''??Ê¾????×¢?Í·???Îª???Ö·???????????#?????????Ý¾Í²??á±»Ê¡??

# otu=otu[,-ncol(otu)]
#É¾??????????
otu=t(otu)
#×ª??

shannon=diversity(otu,"shannon")
#??????Å©Ö¸??
simpson=diversity(otu,"simpson")
#????????É­Ö¸??

alpha_data <- diversity(otu,
                        index = "shannon") %>% 
  as.data.frame() %>% 
  bind_cols(diversity(otu, index = "simpson")) %>% 
  bind_cols(specnumber(otu)) %>% 
  bind_cols(estimateR(otu)[2,]) %>%
  bind_cols(estimateR(otu)[4,]) %>% 
  #pielou Ö¸??
  bind_cols(diversity(otu,index = "shannon")/log(specnumber(otu),exp(1))) %>%
  #????????
  magrittr::set_colnames(c("Shannon.Wiener","Simpson","observed_species",
                           "Chao1","ACE","pielou")) %>% 
  rownames_to_column("sample") 

# alpha=data.frame(shannon,simpson)
#?Ï²?????
write.table(alpha_data,'alpha-summary.tsv',sep = '\t',quote=F, col.names = TRUE, row.names = FALSE)
#????????


map<-read.table('E:/lesson1/mapping_file.txt',row.names = 1,header = T,sep='\t',comment.char='',check.names=F)
#??È¡????????
#row.names = 1??Ê¾Ö¸????Ò»??Îª????
#header = T??Ê¾Ö¸????Ò»????Ð§??Îª????
#sep='\t'??Ê¾Ö¸???Æ±???Îª?Ö¸???
#comment.char=''??Ê¾????×¢?Í·???Îª???Ö·???????????#?????????Ý¾Í²??á±»Ê¡??
#check.names=F??Ê¾??È¡?????Ð²????????????????Îº??Þ¸?
group<-map['Group1']
#??È¡??Òª?Ä·??é£¬'Group1'Îª???Ð·???????
alpha<-read.table('E:/lesson1/alpha-summary.tsv',header = T,row.names = 1,sep = '\t')
#??È¡alpha?????Ô±?
alpha<-alpha[match(rownames(group),rownames(alpha)),]
#????alpha???Ðµ?Ë³????Ê¹????group??????id????????Ë³??Ò»??
data<-data.frame(group,alpha)
#?Ï²?Á½??????


p=ggplot(data = data,aes(x=Group1,y=shannon))+geom_boxplot(fill=rainbow(7)[5])
p
#data = dataÖ¸?????Ý±???
#x=Group1Ö¸????Îªx????????????
#y=shannonÖ¸????Îªy????????????
#geom_boxplot()??Ê¾??????Í¼
mycompare=list(c('A','B'),c('A','C'),c('B','C'))
#Ö¸?????Ø±È½ÏµÄ·?????
p<-p+stat_compare_means(comparisons=mycompare,label = "p.signif",method = 'wilcox')
p
#?????ÇºÅ£??????????Ô±??ÇµÄµ?Ò»?Ö·???,Ê¹??wilcoxon?Ç²??????é·½??

anova <- aov(shannon~Group1,data = data)
plotdata<-duncan.test(anova,"Group1",console = TRUE, alpha = 0.05)
plotdata<-data.frame(id=rownames(plotdata$groups),plotdata$groups)
p<-p+geom_text(data = plotdata,aes(x=id,y=5,label=groups))
p

#????????????Ä¸???????????Ô±??ÇµÄµÚ¶??Ö·?????×¢???Ë·???Îª???????é£¬Òª??alpha??????Ö¸????????Ì«?Ö²?

p=p+xlab("")+ylab("Shannon")
#???Äº?????????????????????
p=p+theme(text = element_text(size = 15,face = "bold"))
p
#?Þ¸??Öº?????
ggsave(plot = p,'E:/lesson1/shannon_boxplot2.png',height = 7,width = 6,dpi = 300)
#plot = pÖ¸???Õ¸Õµ??????ÎºÃµ?p
# ??E:/practice1/shannon_boxplot.pdf????Ê¾?æ´¢Â·?????Ä¼????Ö£?
#×¢???Ä¼??Äº?×º????????????Í¼Æ¬??Ê½
#???é´¢??Îªpdf??Ê½??????Ô­????????×¢?????Ä½???



